name: Scrape completo (mensual)

on:
  schedule:
    # Dia 1 de cada mes, 06:00 UTC
    - cron: '0 6 1 * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  full-scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install -r requirements.txt

      - name: Scrape completo de fuentes oficiales
        id: scrape
        run: |
          cd scripts
          python scrape_official.py --all --output-json
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Subir archivos raw como artifacts
        uses: actions/upload-artifact@v4
        with:
          name: raw-scrape-${{ github.run_number }}
          path: data/PE/sources/raw/
          retention-days: 90
        if: always()

      - name: Verificar cambios detectados
        id: changes
        run: |
          if [ -f data/PE/sources/raw/latest_check.json ]; then
            NEEDS_UPDATE=$(python3 -c "
          import json
          with open('data/PE/sources/raw/latest_check.json') as f:
              data = json.load(f)
          items = data.get('needs_update', [])
          print(len(items))
          " 2>/dev/null || echo "0")
            echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          else
            echo "needs_update=0" >> $GITHUB_OUTPUT
          fi

      - name: Crear Issue si hay cambios detectados
        if: steps.changes.outputs.needs_update != '0'
        run: |
          EXISTING=$(gh issue list --label "legal-data" --state open --limit 1 --json number -q '.[0].number' || echo "")
          if [ -z "$EXISTING" ]; then
            gh issue create \
              --title "Scrape mensual: cambios detectados en fuentes oficiales" \
              --body "$(cat <<'EOF'
          ## Scrape completo mensual

          El scrape automatico detecto posibles cambios en las fuentes oficiales.

          ### Acciones requeridas

          - [ ] Revisar artifacts del run para los archivos raw descargados
          - [ ] Comparar con datos actuales en data/PE/sources/
          - [ ] Actualizar JSON si hay cambios confirmados
          - [ ] Revision por abogado para cambios sustantivos
          - [ ] Correr tests: make test

          _Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}_
          EOF
          )" \
              --label "legal-data"
          else
            echo "Issue #$EXISTING ya existe, no se crea duplicado."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit historial
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f data/PE/verification_history.jsonl ]; then
            git add data/PE/verification_history.jsonl
            git diff --staged --quiet || git commit -m "chore: registro de scrape mensual [auto]"
            git push
          fi
