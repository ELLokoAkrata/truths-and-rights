name: Check estado de emergencia (semanal)

on:
  schedule:
    # Lunes 14:00 UTC = 9:00 AM Lima
    - cron: '0 14 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  check-emergency:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar dependencias
        run: pip install -r requirements.txt

      - name: Verificar estado de emergencia
        id: check
        run: |
          cd scripts
          set +e
          python scrape_official.py --check-emergency --output-json
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

          # Semantica del script:
          # 0 = sin cambios, 1 = cambios detectados (esperado), 2 = error tecnico.
          if [ "$EXIT_CODE" -eq 2 ]; then
            echo "::error::El verificador de emergencia fallo con codigo 2."
            exit 2
          fi

          exit 0

      - name: Leer resultado
        id: result
        run: |
          if [ -f data/PE/sources/raw/latest_check.json ]; then
            NEEDS_UPDATE=$(python3 -c "
          import json
          with open('data/PE/sources/raw/latest_check.json') as f:
              data = json.load(f)
          items = data.get('needs_update', [])
          print(len(items))
          ")
            echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT

            # Extraer info para el issue
            python3 -c "
          import json
          with open('data/PE/sources/raw/latest_check.json') as f:
              data = json.load(f)
          items = data.get('needs_update', [])
          if items:
              body_lines = ['## Estado de emergencia requiere atencion\n']
              for item in items:
                  status = item.get('status', 'unknown')
                  decree = item.get('decree', 'N/A')
                  days = item.get('days_left', '?')
                  end = item.get('end_date', 'N/A')
                  if status == 'expired':
                      body_lines.append(f'- **VENCIDO:** {decree} (vencio {end})')
                  else:
                      body_lines.append(f'- **Vence pronto:** {decree} ({days} dias restantes, vence {end})')
              body_lines.append('\n### Acciones requeridas\n')
              body_lines.append('- [ ] Verificar en El Peruano si el decreto fue renovado')
              body_lines.append('- [ ] Actualizar data/PE/contexts/contexts.json')
              body_lines.append('- [ ] Actualizar data/PE/metadata.json')
              body_lines.append('- [ ] Correr tests: make test')
              body_lines.append(f'\n_Verificacion automatica: {data.get(\"timestamp\", \"N/A\")}_')
              with open('issue_body.txt', 'w') as out:
                  out.write('\n'.join(body_lines))
          " 2>/dev/null || true
          else
            echo "needs_update=0" >> $GITHUB_OUTPUT
          fi

      - name: Crear Issue si hay cambios
        if: steps.result.outputs.needs_update != '0'
        run: |
          # De-duplicacion: no crear issue si ya existe uno abierto
          EXISTING=$(gh issue list --label "legal-data" --state open --limit 1 --json number -q '.[0].number' || echo "")
          if [ -z "$EXISTING" ]; then
            BODY=$(cat issue_body.txt 2>/dev/null || echo "Verificacion automatica detecto cambios en estado de emergencia.")
            gh issue create \
              --title "Estado de emergencia: verificar renovacion de decreto" \
              --body "$BODY" \
              --label "legal-data" \
              --label "urgent" \
              --label "country:PE" || \
            gh issue create \
              --title "Estado de emergencia: verificar renovacion de decreto" \
              --body "$BODY"
          else
            echo "Issue #$EXISTING ya existe, no se crea duplicado."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit historial de verificacion
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f data/PE/verification_history.jsonl ]; then
            git add data/PE/verification_history.jsonl
            git diff --staged --quiet || git commit -m "chore: registro de verificacion de emergencia [auto]"
            git push
          fi
